---
title: "Neel"
output: html_document
date: "2024-07-08"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
library(rerddap)
library(terra)
library(tidyverse)
```
Hello, have a good day!
```{r}
#Loading Data
Tempinfo = info('erdCinpKfmT')
tempset = tabledap(Tempinfo)
Kelpinfo = info('erdCinpKfmRPC')
kelpset = tabledap(Kelpinfo)
Heatwavedata = rast("subset (1).nc")
```
```{r}
# Only taking significant giant kelp data

giantkelpset = kelpset %>%
  rename(date = time) %>% # this is for matching variables later for full_join
  select(station, longitude, latitude, depth, date | contains("Macrocystis_pyrifera")) %>% 
  filter(!is.na(Macrocystis_pyrifera_All_Mean) & date >= 1993-05-22) %>% # now we have all the actual values for giant kelp cover within the time frame of the temperature dataset
  group_by(date) %>% 
  mutate(percentcover = Macrocystis_pyrifera_All_Mean, meanpercentcover = mean(percentcover), meandepth = mean(depth)) %>% # make the percent cover easier to type and take the average of it across all locations
  select(-Macrocystis_pyrifera_All_Mean) %>% # removing unnecessary variables 
  relocate(percentcover, .after = date) %>% # formatting
  arrange(date) # formatting

ggplot(giantkelpset, aes(x = date, y = meanpercentcover, color = meandepth)) + geom_point() + geom_line() + geom_smooth(method = "lm") # first look at the data 
```
```{r}
# Working with the .nc for the heatwave

Heatwavedf = as.data.frame(Heatwavedata, xy = T) # turns it into a DF
dates = seq(from = as.Date("1992-12-31"), to = as.Date("2008-1-1"), by = "day") # creates dates for the dataframe

hwdf_comp = Heatwavedf %>%
  mutate(x = x - 360) %>% 
  filter(x >= -118.4 | x <= -120.4) %>% 
  filter(y >= 32.8, y <= 34.05) %>% # limit the region to the Channel Islands
  slice(18) %>% # the observation that fits the region the best
  pivot_longer(cols = 3:5482,
               names_to = "date",
               values_to = "anomalies") %>% # turns into a long format
  mutate(date = dates, data_char = as.character(date)) %>% # adding the dates to the dataframe
  filter(grepl("-07-01",data_char, fixed = TRUE)) %>% # filtering for July 1st
  select(-data_char) # getting rid of the date as character variable (date as time is still there)
```

Working with the temperature dataset (Jerry did this)
``` {r}
temp_tempset = tempset %>% 
  mutate(data_char = as.character(time)) %>%
  filter(grepl("-07-01",data_char, fixed = TRUE))
```

``` {r}
repvector = rep(0, 2007-1993+1)
tempvector = rep(0, 2007-1993+1)
maxtempvector = rep(0, 2007-1993+1)
for(i in 1:nrow(temp_tempset)){
  yearval = as.numeric(str_sub(temp_tempset$data_char[i], 1, 4))
  index = yearval - 1993
  repvector[index] = repvector[index] + 1
  tempvector[index] = tempvector[index] + temp_tempset$temperature[i]
  maxtempvector[index] = max(maxtempvector[index], temp_tempset$temperature[i])
}
avgtempvector = rep(0, 2007-1993+1)
for(i in 1:length(tempvector)){
  avgtempvector[i] = tempvector[i]/repvector[i]
}

date = seq(from = as.Date("1993-07-01"), to = as.Date("2007-07-01"), by = "year")
```
Making it all one dataframe
``` {r}
onedf = full_join(giantkelpset, hwdf_comp) %>% 
  select(-x, -y)

temporarydf = data.frame(date, avgtempvector, maxtempvector)

onedf = full_join(onedf, temporarydf)
```